<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Chatbot</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #f8f9fb; --surface: #ffffff; --primary: #4f46e5;
            --primary-hover: #4338ca; --text: #1e293b; --muted: #64748b;
            --border: #e2e8f0; --success: #10b981; --radius: 12px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; padding: 16px;
        }
        .container { width: 100%; max-width: 640px; }

        /* ── Join Screen ── */
        #join-screen {
            background: var(--surface); border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0,0,0,.06); padding: 48px 36px;
            text-align: center;
        }
        #join-screen h1 { font-size: 1.75rem; margin-bottom: 8px; }
        #join-screen p { color: var(--muted); margin-bottom: 32px; }
        .code-input {
            width: 100%; max-width: 320px; margin: 0 auto; display: block;
            font-size: 1.5rem; text-align: center; letter-spacing: 6px;
            padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius);
            outline: none; text-transform: uppercase; font-weight: 600;
        }
        .code-input:focus { border-color: var(--primary); }
        .btn {
            display: inline-block; padding: 12px 32px; font-size: 1rem; font-weight: 600;
            border: none; border-radius: var(--radius); cursor: pointer;
            background: var(--primary); color: #fff; margin-top: 20px;
            transition: background .15s;
        }
        .btn:hover { background: var(--primary-hover); }
        .btn:disabled { opacity: .5; cursor: not-allowed; }
        .error { color: #ef4444; margin-top: 12px; font-size: .9rem; }

        /* ── Chat Screen ── */
        #chat-screen { display: none; height: 92vh; flex-direction: column; }
        .chat-header {
            background: var(--surface); border-radius: var(--radius) var(--radius) 0 0;
            padding: 18px 24px; box-shadow: 0 2px 8px rgba(0,0,0,.04);
            display: flex; align-items: center; justify-content: space-between;
        }
        .chat-header h2 { font-size: 1.1rem; }
        .end-btn {
            padding: 6px 16px; font-size: .85rem; font-weight: 600;
            border: 2px solid #ef4444; color: #ef4444; background: transparent;
            border-radius: 8px; cursor: pointer; transition: all .15s;
        }
        .end-btn:hover { background: #ef4444; color: #fff; }
        .messages {
            flex: 1; overflow-y: auto; padding: 20px 24px;
            background: var(--bg); display: flex; flex-direction: column; gap: 12px;
        }
        .msg {
            max-width: 80%; padding: 12px 16px; border-radius: 16px;
            line-height: 1.5; font-size: .95rem; word-wrap: break-word;
            white-space: pre-wrap;
        }
        .msg.assistant {
            background: var(--surface); box-shadow: 0 1px 4px rgba(0,0,0,.05);
            align-self: flex-start; border-bottom-left-radius: 4px;
        }
        .msg.user {
            background: var(--primary); color: #fff;
            align-self: flex-end; border-bottom-right-radius: 4px;
        }
        .msg.system {
            align-self: center; background: #fef3c7; color: #92400e;
            font-size: .85rem; border-radius: 8px; text-align: center;
        }
        .typing {
            align-self: flex-start; color: var(--muted); font-style: italic;
            font-size: .9rem; padding: 8px 0;
        }
        .chat-input-area {
            background: var(--surface); padding: 16px 20px;
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: 0 -2px 8px rgba(0,0,0,.04);
            display: flex; gap: 10px;
        }
        .chat-input-area textarea {
            flex: 1; resize: none; border: 2px solid var(--border);
            border-radius: 10px; padding: 10px 14px; font-size: .95rem;
            font-family: inherit; outline: none; min-height: 44px; max-height: 120px;
        }
        .chat-input-area textarea:focus { border-color: var(--primary); }
        .send-btn {
            padding: 0 20px; background: var(--primary); color: #fff; border: none;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: .95rem;
            transition: background .15s;
        }
        .send-btn:hover { background: var(--primary-hover); }
        .send-btn:disabled { opacity: .5; cursor: not-allowed; }

        /* ── Complete Screen ── */
        #complete-screen {
            display: none; background: var(--surface); border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0,0,0,.06); padding: 48px 36px;
            text-align: center;
        }
        .check-icon { font-size: 3rem; margin-bottom: 16px; }
    </style>
</head>
<body>
<div class="container">
    <!-- Join Screen -->
    <div id="join-screen">
        <h1>Survey Chatbot</h1>
        <p>Enter your survey code to begin</p>
        <input class="code-input" id="code-input" maxlength="10" placeholder="ABC123" autocomplete="off">
        <br>
        <button class="btn" id="join-btn" onclick="joinSurvey()">Start Survey</button>
        <div class="error" id="join-error"></div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen">
        <div class="chat-header">
            <h2 id="survey-title">Survey</h2>
            <button class="end-btn" onclick="endSurvey()">End Survey</button>
        </div>
        <div class="messages" id="messages"></div>
        <div class="chat-input-area">
            <textarea id="chat-input" rows="1" placeholder="Type your response…"
                      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
            <button class="send-btn" id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- Complete Screen -->
    <div id="complete-screen">
        <div class="check-icon">&#10003;</div>
        <h2>Thank you!</h2>
        <p style="color:var(--muted);margin-top:8px;">Your survey responses have been recorded.</p>
    </div>
</div>

<script>
let sessionToken = null;

function show(id) {
    ['join-screen','chat-screen','complete-screen'].forEach(s =>
        document.getElementById(s).style.display = 'none');
    document.getElementById(id).style.display = id === 'chat-screen' ? 'flex' : 'block';
}

function addMessage(role, content) {
    const el = document.createElement('div');
    el.className = `msg ${role}`;
    el.textContent = content;
    document.getElementById('messages').appendChild(el);
    el.scrollIntoView({ behavior: 'smooth' });
}

function showTyping() {
    const el = document.createElement('div');
    el.className = 'typing';
    el.id = 'typing';
    el.textContent = 'Thinking…';
    document.getElementById('messages').appendChild(el);
    el.scrollIntoView({ behavior: 'smooth' });
}

function hideTyping() {
    const el = document.getElementById('typing');
    if (el) el.remove();
}

async function joinSurvey() {
    const code = document.getElementById('code-input').value.trim();
    if (!code) return;
    const btn = document.getElementById('join-btn');
    const err = document.getElementById('join-error');
    btn.disabled = true; err.textContent = '';

    try {
        const res = await fetch('/api/survey/join', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ survey_code: code }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed to join');

        sessionToken = data.session_token;
        document.getElementById('survey-title').textContent = data.survey_title;
        show('chat-screen');
        addMessage('assistant', data.opening_message);
    } catch (e) {
        err.textContent = e.message;
    } finally {
        btn.disabled = false;
    }
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || !sessionToken) return;

    input.value = '';
    addMessage('user', text);
    document.getElementById('send-btn').disabled = true;
    showTyping();

    try {
        const res = await fetch('/api/survey/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ session_token: sessionToken, message: text }),
        });
        const data = await res.json();
        hideTyping();
        if (!res.ok) throw new Error(data.detail || 'Error');

        addMessage('assistant', data.response);
        if (data.is_complete) {
            setTimeout(() => show('complete-screen'), 2000);
        }
    } catch (e) {
        hideTyping();
        addMessage('system', 'Error: ' + e.message);
    } finally {
        document.getElementById('send-btn').disabled = false;
        input.focus();
    }
}

async function endSurvey() {
    if (!confirm('Are you sure you want to end this survey?')) return;
    try {
        await fetch('/api/survey/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ session_token: sessionToken, message: '' }),
        });
    } catch(e) {}
    show('complete-screen');
}

// Auto-resize textarea
document.getElementById('chat-input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
</script>
</body>
</html>
