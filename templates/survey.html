<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Chatbot</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #f8f9fb; --surface: #ffffff; --primary: #4f46e5;
            --primary-hover: #4338ca; --text: #1e293b; --muted: #64748b;
            --border: #e2e8f0; --success: #10b981; --radius: 12px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; padding: 16px;
        }
        .container { width: 100%; max-width: 640px; }

        /* ── Join Screen ── */
        #join-screen {
            background: var(--surface); border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0,0,0,.06); padding: 48px 36px;
            text-align: center;
        }
        #join-screen h1 { font-size: 1.75rem; margin-bottom: 8px; }
        #join-screen p { color: var(--muted); margin-bottom: 32px; }
        .code-input {
            width: 100%; max-width: 320px; margin: 0 auto; display: block;
            font-size: 1.5rem; text-align: center; letter-spacing: 6px;
            padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius);
            outline: none; text-transform: uppercase; font-weight: 600;
        }
        .code-input:focus { border-color: var(--primary); }
        .btn {
            display: inline-block; padding: 12px 32px; font-size: 1rem; font-weight: 600;
            border: none; border-radius: var(--radius); cursor: pointer;
            background: var(--primary); color: #fff; margin-top: 20px;
            transition: background .15s;
        }
        .btn:hover { background: var(--primary-hover); }
        .btn:disabled { opacity: .5; cursor: not-allowed; }
        .error { color: #ef4444; margin-top: 12px; font-size: .9rem; }

        /* ── Chat Screen ── */
        #chat-screen { display: none; height: 92vh; flex-direction: column; }
        .chat-header {
            background: var(--surface); border-radius: var(--radius) var(--radius) 0 0;
            padding: 18px 24px; box-shadow: 0 2px 8px rgba(0,0,0,.04);
            display: flex; align-items: center; justify-content: space-between;
        }
        .chat-header h2 { font-size: 1.1rem; }
        .end-btn {
            padding: 6px 16px; font-size: .85rem; font-weight: 600;
            border: 2px solid #ef4444; color: #ef4444; background: transparent;
            border-radius: 8px; cursor: pointer; transition: all .15s;
        }
        .end-btn:hover { background: #ef4444; color: #fff; }
        .messages {
            flex: 1; overflow-y: auto; padding: 20px 24px;
            background: var(--bg); display: flex; flex-direction: column; gap: 12px;
        }
        .msg {
            max-width: 80%; padding: 12px 16px; border-radius: 16px;
            line-height: 1.5; font-size: .95rem; word-wrap: break-word;
            white-space: pre-wrap;
        }
        .msg.assistant {
            background: var(--surface); box-shadow: 0 1px 4px rgba(0,0,0,.05);
            align-self: flex-start; border-bottom-left-radius: 4px;
        }
        .msg.user {
            background: var(--primary); color: #fff;
            align-self: flex-end; border-bottom-right-radius: 4px;
        }
        .msg.system {
            align-self: center; background: #fef3c7; color: #92400e;
            font-size: .85rem; border-radius: 8px; text-align: center;
        }
        .typing {
            align-self: flex-start; color: var(--muted); font-style: italic;
            font-size: .9rem; padding: 8px 0;
        }

        /* Animated mascot (chat screen only) */
        .mascot-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .mascot-typing .mascot-left-arm {
            animation: mascot-type-left 0.15s infinite alternate;
            transform-origin: 40px 70px;
        }
        .mascot-typing .mascot-right-arm {
            animation: mascot-type-right 0.15s infinite alternate;
            transform-origin: 80px 70px;
        }
        .mascot-typing .mascot-head {
            animation: mascot-bob 0.3s infinite;
        }
        .mascot-typing .mascot-hand-left {
            animation: mascot-wiggle-left 0.15s infinite alternate;
        }
        .mascot-typing .mascot-hand-right {
            animation: mascot-wiggle-right 0.15s infinite alternate;
        }
        @keyframes mascot-type-left {
            0% { transform: rotate(-25deg); }
            100% { transform: rotate(-15deg); }
        }
        @keyframes mascot-type-right {
            0% { transform: rotate(25deg); }
            100% { transform: rotate(15deg); }
        }
        @keyframes mascot-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        @keyframes mascot-wiggle-left {
            0% { transform: translate(0, 0) rotate(-5deg); }
            100% { transform: translate(-2px, 2px) rotate(-10deg); }
        }
        @keyframes mascot-wiggle-right {
            0% { transform: translate(0, 0) rotate(5deg); }
            100% { transform: translate(2px, 2px) rotate(10deg); }
        }
        .mascot-status {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            background: var(--success);
            border: 3px solid white;
            border-radius: 50%;
        }
        .mascot-status.active {
            animation: mascot-pulse 1s infinite;
        }
        @keyframes mascot-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        @media (max-width: 768px) {
            .mascot-container {
                top: 10px;
                right: 10px;
                transform: scale(0.8);
            }
        }

        .chat-input-area {
            background: var(--surface); padding: 16px 20px;
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: 0 -2px 8px rgba(0,0,0,.04);
            display: flex; gap: 10px;
        }
        .chat-input-area textarea {
            flex: 1; resize: none; border: 2px solid var(--border);
            border-radius: 10px; padding: 10px 14px; font-size: .95rem;
            font-family: inherit; outline: none; min-height: 44px; max-height: 120px;
        }
        .chat-input-area textarea:focus { border-color: var(--primary); }
        .send-btn {
            padding: 0 20px; background: var(--primary); color: #fff; border: none;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: .95rem;
            transition: background .15s;
        }
        .send-btn:hover { background: var(--primary-hover); }
        .send-btn:disabled { opacity: .5; cursor: not-allowed; }

        /* ── Complete Screen ── */
        #complete-screen {
            display: none; background: var(--surface); border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0,0,0,.06); padding: 48px 36px;
            text-align: center;
        }
        .check-icon { font-size: 3rem; margin-bottom: 16px; }
    </style>
</head>
<body>
<div class="container">
    <!-- Join Screen -->
    <div id="join-screen">
        <h1>Survey Chatbot</h1>
        <p>Enter your survey code to begin</p>
        <input class="code-input" id="code-input" maxlength="10" placeholder="ABC123" autocomplete="off">
        <br>
        <button class="btn" id="join-btn" onclick="joinSurvey()">Start Survey</button>
        <div class="error" id="join-error"></div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen">
        <div class="mascot-container" id="mascot-container">
            <svg id="mascot-svg" width="140" height="140" viewBox="0 0 140 140">
                <rect x="35" y="105" width="70" height="20" rx="4" fill="#2c3e50" opacity="0.9"/>
                <rect x="40" y="109" width="8" height="6" rx="1" fill="#34495e"/>
                <rect x="50" y="109" width="8" height="6" rx="1" fill="#34495e"/>
                <rect x="60" y="109" width="8" height="6" rx="1" fill="#34495e"/>
                <rect x="70" y="109" width="8" height="6" rx="1" fill="#34495e"/>
                <rect x="80" y="109" width="8" height="6" rx="1" fill="#34495e"/>
                <rect x="90" y="109" width="8" height="6" rx="1" fill="#34495e"/>
                <ellipse cx="70" cy="85" rx="28" ry="32" fill="#8B4513"/>
                <path d="M 90 85 Q 110 85 115 95 Q 118 105 110 110" stroke="#8B4513" stroke-width="6" fill="none" stroke-linecap="round"/>
                <g class="mascot-left-arm">
                    <ellipse cx="45" cy="78" rx="10" ry="22" fill="#8B4513" transform="rotate(-20 45 78)"/>
                    <g class="mascot-hand-left">
                        <ellipse cx="38" cy="95" rx="8" ry="10" fill="#CD853F"/>
                        <circle cx="35" cy="96" r="2" fill="#8B4513"/>
                        <circle cx="38" cy="98" r="2" fill="#8B4513"/>
                        <circle cx="41" cy="96" r="2" fill="#8B4513"/>
                    </g>
                </g>
                <g class="mascot-right-arm">
                    <ellipse cx="95" cy="78" rx="10" ry="22" fill="#8B4513" transform="rotate(20 95 78)"/>
                    <g class="mascot-hand-right">
                        <ellipse cx="102" cy="95" rx="8" ry="10" fill="#CD853F"/>
                        <circle cx="99" cy="96" r="2" fill="#8B4513"/>
                        <circle cx="102" cy="98" r="2" fill="#8B4513"/>
                        <circle cx="105" cy="96" r="2" fill="#8B4513"/>
                    </g>
                </g>
                <g class="mascot-head" transform-origin="70 50">
                    <circle cx="70" cy="50" r="32" fill="#CD853F"/>
                    <circle cx="45" cy="48" r="10" fill="#CD853F"/>
                    <circle cx="95" cy="48" r="10" fill="#CD853F"/>
                    <circle cx="45" cy="48" r="6" fill="#DEB887"/>
                    <circle cx="95" cy="48" r="6" fill="#DEB887"/>
                    <ellipse cx="70" cy="60" rx="22" ry="18" fill="#DEB887"/>
                    <ellipse cx="58" cy="45" rx="6" ry="8" fill="white"/>
                    <ellipse cx="82" cy="45" rx="6" ry="8" fill="white"/>
                    <circle cx="58" cy="47" r="4" fill="#000"/>
                    <circle cx="82" cy="47" r="4" fill="#000"/>
                    <circle cx="59" cy="45" r="2" fill="#FFF"/>
                    <circle cx="83" cy="45" r="2" fill="#FFF"/>
                    <path d="M 52 38 Q 58 36 64 38" stroke="#8B4513" stroke-width="2" fill="none" stroke-linecap="round"/>
                    <path d="M 76 38 Q 82 36 88 38" stroke="#8B4513" stroke-width="2" fill="none" stroke-linecap="round"/>
                    <ellipse cx="70" cy="55" rx="4" ry="5" fill="#8B4513"/>
                    <circle cx="68" cy="54" r="1.5" fill="#000"/>
                    <circle cx="72" cy="54" r="1.5" fill="#000"/>
                    <path d="M 60 62 Q 70 67 80 62" stroke="#8B4513" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <circle cx="56" cy="62" r="2" fill="#CD853F" opacity="0.3"/>
                    <circle cx="84" cy="62" r="2" fill="#CD853F" opacity="0.3"/>
                </g>
            </svg>
            <div class="mascot-status" id="mascot-status"></div>
        </div>
        <div class="chat-header">
            <h2 id="survey-title">Survey</h2>
            <button class="end-btn" onclick="endSurvey()">End Survey</button>
        </div>
        <div class="messages" id="messages"></div>
        <div class="chat-input-area">
            <textarea id="chat-input" rows="1" placeholder="Type your response…"
                      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
            <button class="send-btn" id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- Complete Screen -->
    <div id="complete-screen">
        <div class="check-icon">&#10003;</div>
        <h2>Thank you!</h2>
        <p style="color:var(--muted);margin-top:8px;">Your survey responses have been recorded.</p>
    </div>
</div>

<script>
let sessionToken = null;

function show(id) {
    ['join-screen','chat-screen','complete-screen'].forEach(s =>
        document.getElementById(s).style.display = 'none');
    document.getElementById(id).style.display = id === 'chat-screen' ? 'flex' : 'block';
}

function addMessage(role, content) {
    const el = document.createElement('div');
    el.className = `msg ${role}`;
    el.textContent = content;
    document.getElementById('messages').appendChild(el);
    el.scrollIntoView({ behavior: 'smooth' });
    return el;
}

function addStreamingMessage() {
    const el = document.createElement('div');
    el.className = 'msg assistant';
    el.id = 'streaming-msg';
    document.getElementById('messages').appendChild(el);
    el.scrollIntoView({ behavior: 'smooth' });
    return el;
}

function showTyping() {
    const el = document.createElement('div');
    el.className = 'typing';
    el.id = 'typing';
    el.textContent = 'Thinking…';
    document.getElementById('messages').appendChild(el);
    el.scrollIntoView({ behavior: 'smooth' });
    startMascotTyping();
}

function hideTyping() {
    const el = document.getElementById('typing');
    if (el) el.remove();
    stopMascotTyping();
}

function startMascotTyping() {
    const svg = document.getElementById('mascot-svg');
    const status = document.getElementById('mascot-status');
    if (svg) svg.classList.add('mascot-typing');
    if (status) status.classList.add('active');
}

function stopMascotTyping() {
    const svg = document.getElementById('mascot-svg');
    const status = document.getElementById('mascot-status');
    if (svg) svg.classList.remove('mascot-typing');
    if (status) status.classList.remove('active');
}

async function joinSurvey() {
    const code = document.getElementById('code-input').value.trim();
    if (!code) return;
    const btn = document.getElementById('join-btn');
    const err = document.getElementById('join-error');
    btn.disabled = true; err.textContent = '';

    try {
        const res = await fetch('/api/survey/join', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ survey_code: code }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed to join');

        sessionToken = data.session_token;
        document.getElementById('survey-title').textContent = data.survey_title;
        show('chat-screen');
        addMessage('assistant', data.opening_message);
    } catch (e) {
        err.textContent = e.message;
    } finally {
        btn.disabled = false;
    }
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || !sessionToken) return;

    input.value = '';
    addMessage('user', text);
    document.getElementById('send-btn').disabled = true;
    showTyping();

    try {
        const res = await fetch('/api/survey/chat/stream', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ session_token: sessionToken, message: text }),
        });
        hideTyping();
        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.detail || 'Error');
        }
        const streamEl = addStreamingMessage();
        streamEl.textContent = '';
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        if (data.t === 'chunk' && data.v) {
                            streamEl.textContent += data.v;
                            streamEl.scrollIntoView({ behavior: 'smooth' });
                        } else if (data.t === 'done') {
                            if (data.is_complete) setTimeout(() => show('complete-screen'), 2000);
                        } else if (data.t === 'error') {
                            streamEl.textContent = 'Error: ' + (data.v || 'Unknown');
                        }
                    } catch (_) {}
                }
            }
        }
        if (buffer.startsWith('data: ')) {
            try {
                const data = JSON.parse(buffer.slice(6));
                if (data.t === 'done' && data.is_complete) setTimeout(() => show('complete-screen'), 2000);
            } catch (_) {}
        }
        streamEl.id = '';
    } catch (e) {
        hideTyping();
        addMessage('system', 'Error: ' + e.message);
    } finally {
        document.getElementById('send-btn').disabled = false;
        input.focus();
    }
}

async function endSurvey() {
    if (!confirm('Are you sure you want to end this survey?')) return;
    try {
        await fetch('/api/survey/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ session_token: sessionToken, message: '' }),
        });
    } catch(e) {}
    show('complete-screen');
}

// Auto-resize textarea
document.getElementById('chat-input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Mascot typing when user types in chat (chat screen only)
let mascotTypingTimeout;
document.getElementById('chat-input').addEventListener('input', function() {
    var container = document.getElementById('mascot-container');
    if (!container || document.getElementById('chat-screen').style.display !== 'flex') return;
    startMascotTyping();
    clearTimeout(mascotTypingTimeout);
    mascotTypingTimeout = setTimeout(stopMascotTyping, 500);
});
</script>
</body>
</html>
