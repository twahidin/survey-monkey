<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Admin</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --glass: rgba(255,255,255,0.55);
            --glass-border: rgba(255,255,255,0.3);
            --glass-strong: rgba(255,255,255,0.75);
            --blur: 20px;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-end: #8b5cf6;
            --text: #1e1b4b;
            --muted: #6b7280;
            --border: rgba(255,255,255,0.35);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius: 16px;
            --radius-sm: 10px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e8f0fe 0%, #f0e6ff 50%, #e8f0fe 100%);
            color: var(--text); min-height: 100vh;
        }
        .hidden { display: none !important; }

        /* Orbs */
        .orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.35; pointer-events: none; z-index: 0; animation: float 20s ease-in-out infinite; }
        .orb-1 { width: 400px; height: 400px; background: #c4b5fd; top: -100px; right: -100px; }
        .orb-2 { width: 350px; height: 350px; background: #93c5fd; bottom: -80px; left: -80px; animation-delay: -7s; }
        @keyframes float { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(20px,-15px); } }

        /* ── Auth ── */
        .auth-wrapper { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 16px; position: relative; z-index: 1; }
        .auth-card {
            background: var(--glass); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border); border-radius: var(--radius);
            padding: 40px 36px; width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 8px 32px rgba(99,102,241,0.08);
        }
        .auth-card h1 { font-size: 1.4rem; margin-bottom: 4px; }
        .auth-card .sub { color: var(--muted); margin-bottom: 28px; font-size: 0.9rem; }
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-group label { font-size: 0.82rem; font-weight: 600; display: block; margin-bottom: 4px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.5);
            border: 1.5px solid var(--border); border-radius: 8px;
            font-size: 0.93rem; outline: none; font-family: inherit; transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--primary); }
        .btn {
            display: inline-block; padding: 10px 24px; font-size: 0.93rem; font-weight: 600;
            border: none; border-radius: 8px; cursor: pointer;
            background: linear-gradient(135deg, var(--primary), var(--primary-end)); color: #fff;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(99,102,241,0.25); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-outline { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(99,102,241,0.08); transform: translateY(-1px); box-shadow: none; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { box-shadow: 0 4px 16px rgba(239,68,68,0.25); }
        .btn-success { background: var(--success); }
        .btn-sm { padding: 6px 14px; font-size: 0.82rem; }
        .error { color: var(--danger); margin-top: 8px; font-size: 0.82rem; }
        .link-btn { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.88rem; text-decoration: underline; }

        /* ── Layout ── */
        .topbar {
            background: var(--glass-strong); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border-bottom: 1px solid var(--glass-border);
            padding: 12px 28px; display: flex; align-items: center;
            justify-content: space-between; position: sticky; top: 0; z-index: 10;
        }
        .topbar h1 { font-size: 1.1rem; }
        .topbar .user-info { display: flex; align-items: center; gap: 12px; }
        .main { max-width: 1100px; margin: 0 auto; padding: 28px 20px; position: relative; z-index: 1; }

        /* ── Glass Card ── */
        .glass-card {
            background: var(--glass); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border); border-radius: var(--radius);
            padding: 24px; margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.04);
        }
        .glass-card h3 { margin-bottom: 16px; font-size: 1rem; }

        /* ── Survey Grid ── */
        .survey-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .survey-card {
            background: var(--glass); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border); border-radius: var(--radius);
            padding: 20px; cursor: pointer; transition: all 0.2s;
        }
        .survey-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(99,102,241,0.12); border-color: var(--primary); }
        .survey-card h3 { font-size: 1rem; margin-bottom: 6px; }
        .survey-card .code { font-family: monospace; font-size: 1.05rem; font-weight: 700; color: var(--primary); }
        .badge {
            display: inline-block; padding: 2px 10px; border-radius: 99px;
            font-size: 0.72rem; font-weight: 700; text-transform: uppercase;
        }
        .badge-active { background: rgba(16,185,129,0.15); color: #065f46; }
        .badge-closed { background: rgba(239,68,68,0.15); color: #991b1b; }
        .badge-draft { background: rgba(99,102,241,0.15); color: #3730a3; }
        .stats-row { display: flex; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
        .stat { text-align: center; }
        .stat .num { font-size: 1.2rem; font-weight: 700; }
        .stat .lbl { font-size: 0.72rem; color: var(--muted); }

        /* ── Detail View ── */
        .detail-header { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; }
        .detail-header h2 { flex: 1; font-size: 1.2rem; }
        .stats-bar { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 24px; }
        .stat-box {
            background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: var(--radius-sm);
            padding: 16px 22px; text-align: center; min-width: 110px;
        }
        .stat-box .num { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-box .lbl { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }

        /* ── Tabs ── */
        .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 20px; overflow-x: auto; }
        .tab {
            padding: 10px 18px; font-weight: 600; cursor: pointer;
            border-bottom: 3px solid transparent; color: var(--muted);
            transition: all 0.15s; background: none; border-top: none; border-left: none; border-right: none;
            font-size: 0.9rem; white-space: nowrap;
        }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ── Insights ── */
        .insights-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 700px) { .insights-grid { grid-template-columns: 1fr; } }

        .sentiment-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .sentiment-bar .label { width: 70px; font-size: 0.82rem; font-weight: 600; }
        .sentiment-bar .bar-bg {
            flex: 1; height: 24px; border-radius: 12px; background: rgba(0,0,0,0.06); overflow: hidden;
        }
        .sentiment-bar .bar-fill {
            height: 100%; border-radius: 12px; transition: width 0.5s ease;
            display: flex; align-items: center; justify-content: flex-end; padding-right: 8px;
            font-size: 0.72rem; font-weight: 700; color: #fff; min-width: 0;
        }
        .bar-positive { background: linear-gradient(90deg, #10b981, #34d399); }
        .bar-neutral { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .bar-negative { background: linear-gradient(90deg, #ef4444, #f87171); }

        .theme-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .theme-item:last-child { border-bottom: none; }
        .theme-rank { width: 24px; height: 24px; border-radius: 6px; background: rgba(99,102,241,0.1); color: var(--primary); font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; }
        .theme-name { flex: 1; font-size: 0.88rem; font-weight: 500; }
        .theme-count { font-size: 0.78rem; color: var(--muted); font-weight: 600; background: rgba(0,0,0,0.04); padding: 2px 8px; border-radius: 99px; }

        .engagement-histogram { display: flex; align-items: flex-end; gap: 4px; height: 100px; padding-top: 10px; }
        .histogram-bar {
            flex: 1; border-radius: 4px 4px 0 0; background: linear-gradient(180deg, var(--primary), var(--primary-end));
            transition: height 0.5s ease; min-height: 2px; position: relative;
        }
        .histogram-bar .bar-label {
            position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%);
            font-size: 0.65rem; color: var(--muted);
        }

        /* ── Tables ── */
        .participant-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .participant-table th {
            text-align: left; padding: 10px 12px; border-bottom: 2px solid rgba(0,0,0,0.08);
            font-size: 0.75rem; color: var(--muted); text-transform: uppercase; cursor: pointer;
            user-select: none; white-space: nowrap;
        }
        .participant-table th:hover { color: var(--primary); }
        .participant-table td { padding: 10px 12px; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .participant-table tr { cursor: pointer; transition: background 0.15s; }
        .participant-table tr:hover { background: rgba(99,102,241,0.04); }
        .sentiment-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .dot-positive { background: var(--success); }
        .dot-neutral { background: var(--warning); }
        .dot-negative { background: var(--danger); }
        .engagement-badge { font-size: 0.78rem; font-weight: 700; padding: 2px 8px; border-radius: 99px; }
        .eng-high { background: rgba(16,185,129,0.15); color: #065f46; }
        .eng-mid { background: rgba(245,158,11,0.15); color: #92400e; }
        .eng-low { background: rgba(239,68,68,0.15); color: #991b1b; }

        /* ── Conversation viewer ── */
        .convo-viewer {
            max-height: 500px; overflow-y: auto; padding: 16px;
            background: rgba(255,255,255,0.4); border-radius: var(--radius-sm);
        }
        .convo-msg { margin-bottom: 10px; }
        .convo-msg .role { font-weight: 700; font-size: 0.75rem; text-transform: uppercase; color: var(--muted); }
        .convo-msg .text { margin-top: 2px; white-space: pre-wrap; line-height: 1.5; font-size: 0.9rem; }

        /* ── Analysis Chat ── */
        .analysis-chat { display: flex; flex-direction: column; height: 480px; }
        .analysis-messages {
            flex: 1; overflow-y: auto; padding: 16px;
            background: rgba(255,255,255,0.3); border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            display: flex; flex-direction: column; gap: 10px;
        }
        .analysis-msg { max-width: 85%; padding: 10px 14px; border-radius: 14px; font-size: 0.88rem; line-height: 1.5; white-space: pre-wrap; }
        .analysis-msg.user {
            background: linear-gradient(135deg, var(--primary), var(--primary-end));
            color: #fff; align-self: flex-end; border-bottom-right-radius: 4px;
        }
        .analysis-msg.assistant {
            background: var(--glass-strong); backdrop-filter: blur(12px);
            align-self: flex-start; border-bottom-left-radius: 4px;
            border: 1px solid var(--glass-border);
        }
        .analysis-input-area {
            display: flex; gap: 8px; padding: 12px;
            background: var(--glass-strong); border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            border-top: 1px solid var(--glass-border);
        }
        .analysis-input-area input {
            flex: 1; padding: 10px 12px; background: rgba(255,255,255,0.5);
            border: 1.5px solid var(--border); border-radius: 8px; outline: none; font-size: 0.88rem;
        }
        .analysis-input-area input:focus { border-color: var(--primary); }

        /* ── Modal ── */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; padding: 16px;
        }
        .modal {
            background: var(--glass-strong); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border); border-radius: var(--radius);
            padding: 32px; width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto;
        }
        .modal h2 { margin-bottom: 20px; font-size: 1.15rem; }

        @media (max-width: 600px) {
            .stats-bar { gap: 10px; }
            .stat-box { min-width: 80px; padding: 12px; }
            .topbar { padding: 12px 16px; }
            .main { padding: 20px 12px; }
        }
    </style>
</head>
<body>
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>

<!-- AUTH SCREEN -->
<div id="auth-screen" class="auth-wrapper">
    <div class="auth-card">
        <h1>Survey Admin</h1>
        <p class="sub">Sign in to manage your surveys</p>
        <div id="login-form">
            <div class="form-group">
                <label>Username</label>
                <input id="auth-user" placeholder="admin">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input id="auth-pass" type="password" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;"
                       onkeydown="if(event.key==='Enter')doLogin()">
            </div>
            <button class="btn" style="width:100%;margin-top:8px" onclick="doLogin()">Sign In</button>
            <div class="error" id="auth-error"></div>
            <p style="margin-top:16px">
                <button class="link-btn" onclick="toggleAuthMode()">Create an account</button>
            </p>
        </div>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
    <div class="topbar">
        <h1><a href="javascript:void(0)" onclick="showList()" style="color:inherit;text-decoration:none;cursor:pointer">Survey Admin</a></h1>
        <div class="user-info">
            <span id="admin-name" style="font-size:0.88rem;color:var(--muted)"></span>
            <button class="btn btn-sm btn-outline" onclick="doLogout()">Sign Out</button>
        </div>
    </div>

    <div class="main">
        <!-- Survey List -->
        <div id="list-view">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
                <h2>Your Surveys</h2>
                <button class="btn" onclick="openCreateModal()">+ New Survey</button>
            </div>
            <div class="survey-grid" id="survey-grid"></div>
            <p id="no-surveys" class="hidden" style="text-align:center;color:var(--muted);padding:40px">
                No surveys yet. Create your first one!
            </p>
        </div>

        <!-- Survey Detail -->
        <div id="detail-view" class="hidden">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px">
                <button type="button" class="btn btn-outline btn-sm" onclick="showList()">&larr; Back</button>
            </div>
            <div class="detail-header">
                <h2 id="detail-title"></h2>
                <span id="detail-badge"></span>
                <span id="detail-code" style="font-family:monospace;font-size:1.05rem;font-weight:700;color:var(--primary)"></span>
            </div>
            <div class="stats-bar" id="detail-stats"></div>

            <div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <button class="btn btn-sm btn-danger" id="close-btn" onclick="closeSurvey()">Close Survey</button>
                <button class="btn btn-sm btn-success hidden" id="reopen-btn" onclick="reopenSurvey()">Reopen</button>
                <button class="btn btn-sm btn-outline" onclick="refreshDetail()">Refresh</button>
                <button class="btn btn-sm btn-danger" id="delete-btn" onclick="deleteSurvey()" style="margin-left:auto">Delete</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('insights',this)">Insights</button>
                <button class="tab" onclick="switchTab('participants',this)">Participants</button>
                <button class="tab" onclick="switchTab('conversation',this)">Conversations</button>
                <button class="tab" onclick="switchTab('analysis',this)">Analysis Chat</button>
                <button class="tab" onclick="switchTab('settings',this)">Settings</button>
            </div>

            <!-- Insights Tab -->
            <div class="tab-content active" id="tab-insights">
                <div id="insights-loading" style="text-align:center;padding:40px;color:var(--muted)">Loading insights...</div>
                <div id="insights-content" class="hidden">
                    <div class="insights-grid">
                        <div class="glass-card">
                            <h3>Sentiment Overview</h3>
                            <div id="sentiment-chart"></div>
                        </div>
                        <div class="glass-card">
                            <h3>Top Themes</h3>
                            <div id="themes-list"></div>
                        </div>
                    </div>
                    <div class="glass-card" style="margin-top:16px">
                        <h3>Engagement Distribution</h3>
                        <div id="engagement-chart"></div>
                    </div>
                    <div class="glass-card" style="margin-top:16px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                            <h3 style="margin-bottom:0">Participant Details</h3>
                            <button class="btn btn-sm btn-outline" onclick="regenerateInsights()">Regenerate</button>
                        </div>
                        <div style="overflow-x:auto">
                            <table class="participant-table" id="insights-table">
                                <thead><tr>
                                    <th onclick="sortInsightsTable('id')">ID</th>
                                    <th onclick="sortInsightsTable('sentiment')">Sentiment</th>
                                    <th onclick="sortInsightsTable('engagement')">Engagement</th>
                                    <th>Themes</th>
                                </tr></thead>
                                <tbody id="insights-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participants Tab -->
            <div class="tab-content" id="tab-participants">
                <div style="overflow-x:auto">
                    <table class="participant-table">
                        <thead><tr><th>ID</th><th>Status</th><th>Messages</th><th>Duration</th><th>Started</th></tr></thead>
                        <tbody id="participant-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Conversations Tab -->
            <div class="tab-content" id="tab-conversation">
                <p style="color:var(--muted);margin-bottom:12px;font-size:0.88rem">Select a participant:</p>
                <select id="convo-select" onchange="showConversation(this.value)" style="padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;margin-bottom:16px;font-size:0.88rem;background:rgba(255,255,255,0.5)"></select>
                <div class="convo-viewer" id="convo-viewer"></div>
            </div>

            <!-- Analysis Chat Tab -->
            <div class="tab-content" id="tab-analysis">
                <p style="color:var(--muted);margin-bottom:12px;font-size:0.85rem">
                    Chat with AI to analyze survey responses. Ask about themes, sentiment, insights.
                </p>
                <div class="analysis-chat">
                    <div class="analysis-messages" id="analysis-messages"></div>
                    <div class="analysis-input-area">
                        <input id="analysis-input" placeholder="Ask about survey results..."
                               onkeydown="if(event.key==='Enter')sendAnalysis()">
                        <button class="btn btn-sm" id="analysis-send" onclick="sendAnalysis()">Send</button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <div class="glass-card">
                    <h3>Survey Settings</h3>
                    <div class="form-group">
                        <label>Title</label>
                        <input id="edit-title">
                    </div>
                    <div class="form-group">
                        <label>Topic</label>
                        <input id="edit-topic">
                    </div>
                    <div class="form-group">
                        <label>System Prompt</label>
                        <textarea id="edit-prompt" rows="6"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Facilitator intro</label>
                        <textarea id="edit-facilitator-intro" rows="3" placeholder="My name is..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Max Messages per Participant</label>
                        <input id="edit-max" type="number" min="1" max="100">
                    </div>
                    <button class="btn" onclick="saveSettings()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CREATE MODAL -->
<div id="create-modal" class="modal-overlay hidden" onclick="if(event.target===this)closeCreateModal()">
    <div class="modal">
        <h2>Create New Survey</h2>
        <div class="form-group">
            <label>Title</label>
            <input id="new-title" placeholder="Customer Satisfaction Survey">
        </div>
        <div class="form-group">
            <label>Topic</label>
            <input id="new-topic" placeholder="Gather feedback on our product experience">
        </div>
        <div class="form-group">
            <label>System Prompt (instructions for the chatbot)</label>
            <textarea id="new-prompt" rows="6" placeholder="You are a friendly survey assistant..."></textarea>
        </div>
        <div class="form-group">
            <label>Facilitator intro (your name &amp; intro)</label>
            <textarea id="new-facilitator-intro" rows="3" placeholder="My name is..."></textarea>
        </div>
        <div class="form-group">
            <label>Survey Code (optional)</label>
            <input id="new-code" placeholder="MYCODE" maxlength="10" style="text-transform:uppercase">
        </div>
        <div class="form-group">
            <label>Max Messages per Participant</label>
            <input id="new-max" type="number" value="20" min="1" max="100">
        </div>
        <div style="display:flex;gap:10px;margin-top:20px">
            <button class="btn" onclick="createSurvey()">Create Survey</button>
            <button class="btn btn-outline" onclick="closeCreateModal()">Cancel</button>
        </div>
        <div class="error" id="create-error"></div>
    </div>
</div>

<script>
let token = localStorage.getItem('admin_token');
let currentSurveyId = null;
let currentResults = null;
let currentInsights = null;
let isRegister = false;
let insightsSortCol = null;
let insightsSortAsc = true;

// ── Auth ──
function toggleAuthMode() {
    isRegister = !isRegister;
    document.querySelector('.auth-card h1').textContent = isRegister ? 'Create Account' : 'Survey Admin';
    document.querySelector('.auth-card .sub').textContent = isRegister ? 'Register a new admin account' : 'Sign in to manage your surveys';
    document.querySelector('#login-form .btn').textContent = isRegister ? 'Register' : 'Sign In';
    document.querySelector('#login-form .btn').setAttribute('onclick', isRegister ? 'doRegister()' : 'doLogin()');
    document.querySelector('.link-btn').textContent = isRegister ? 'Already have an account? Sign in' : 'Create an account';
}

async function doLogin() {
    const user = document.getElementById('auth-user').value.trim();
    const pass = document.getElementById('auth-pass').value;
    if (!user || !pass) return;
    try {
        const res = await api('/api/auth/login', 'POST', { username: user, password: pass });
        token = res.token;
        localStorage.setItem('admin_token', token);
        document.getElementById('admin-name').textContent = res.username;
        showDashboard();
    } catch (e) {
        document.getElementById('auth-error').textContent = e.message;
    }
}

async function doRegister() {
    const user = document.getElementById('auth-user').value.trim();
    const pass = document.getElementById('auth-pass').value;
    if (!user || !pass) return;
    try {
        const res = await api('/api/auth/register', 'POST', { username: user, password: pass });
        token = res.token;
        localStorage.setItem('admin_token', token);
        document.getElementById('admin-name').textContent = res.username;
        showDashboard();
    } catch (e) {
        document.getElementById('auth-error').textContent = e.message;
    }
}

function doLogout() {
    token = null;
    localStorage.removeItem('admin_token');
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('auth-screen').classList.remove('hidden');
}

function showDashboard() {
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    loadSurveys();
}

// ── API helper ──
async function api(url, method = 'GET', body = null) {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (token) opts.headers['Authorization'] = `Bearer ${token}`;
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(url, opts);
    const data = await res.json();
    if (!res.ok) {
        if (res.status === 401) {
            doLogout();
            const msg = (body && (body.username !== undefined || body.password !== undefined))
                ? (data.detail || 'Invalid credentials')
                : 'Session expired';
            throw new Error(msg);
        }
        throw new Error(data.detail || 'Request failed');
    }
    return data;
}

// ── Surveys ──
async function loadSurveys() {
    const surveys = await api('/api/surveys');
    const grid = document.getElementById('survey-grid');
    const noSurveys = document.getElementById('no-surveys');
    grid.innerHTML = '';
    if (surveys.length === 0) { noSurveys.classList.remove('hidden'); return; }
    noSurveys.classList.add('hidden');
    surveys.forEach(s => {
        const badgeClass = s.status === 'active' ? 'badge-active' : s.status === 'closed' ? 'badge-closed' : 'badge-draft';
        grid.innerHTML += `
            <div class="survey-card" onclick="openSurvey('${s.id}')">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <h3>${esc(s.title)}</h3>
                    <span class="badge ${badgeClass}">${s.status}</span>
                </div>
                <div class="code">${s.survey_code}</div>
                <div class="stats-row">
                    <div class="stat"><div class="num">${s.active_participants}</div><div class="lbl">Active</div></div>
                    <div class="stat"><div class="num">${s.completed_participants}</div><div class="lbl">Completed</div></div>
                    <div class="stat"><div class="num">${s.total_participants}</div><div class="lbl">Total</div></div>
                </div>
            </div>`;
    });
}

function openCreateModal() { document.getElementById('create-modal').classList.remove('hidden'); }
function closeCreateModal() { document.getElementById('create-modal').classList.add('hidden'); document.getElementById('create-error').textContent = ''; }

async function createSurvey() {
    try {
        const data = {
            title: document.getElementById('new-title').value.trim(),
            topic: document.getElementById('new-topic').value.trim(),
            system_prompt: document.getElementById('new-prompt').value.trim(),
            facilitator_intro: document.getElementById('new-facilitator-intro').value.trim() || undefined,
            survey_code: document.getElementById('new-code').value.trim() || undefined,
            max_messages: parseInt(document.getElementById('new-max').value) || 20,
        };
        if (!data.title || !data.topic || !data.system_prompt) throw new Error('Title, topic, and prompt are required');
        await api('/api/surveys', 'POST', data);
        closeCreateModal();
        ['new-title','new-topic','new-prompt','new-facilitator-intro','new-code'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('new-max').value = '20';
        loadSurveys();
    } catch (e) {
        document.getElementById('create-error').textContent = e.message;
    }
}

// ── Detail ──
function showList() {
    document.getElementById('list-view').classList.remove('hidden');
    document.getElementById('detail-view').classList.add('hidden');
    loadSurveys();
}

async function openSurvey(id) {
    currentSurveyId = id;
    document.getElementById('list-view').classList.add('hidden');
    document.getElementById('detail-view').classList.remove('hidden');
    await refreshDetail();
    loadAnalysisHistory();
    loadInsights();
}

async function refreshDetail() {
    const data = await api(`/api/surveys/${currentSurveyId}/results`);
    currentResults = data;
    const s = data.survey; const st = data.stats;

    document.getElementById('detail-title').textContent = s.title;
    document.getElementById('detail-code').textContent = s.survey_code;
    const badgeClass = s.status === 'active' ? 'badge-active' : s.status === 'closed' ? 'badge-closed' : 'badge-draft';
    document.getElementById('detail-badge').innerHTML = `<span class="badge ${badgeClass}">${s.status}</span>`;

    document.getElementById('close-btn').classList.toggle('hidden', s.status !== 'active');
    document.getElementById('reopen-btn').classList.toggle('hidden', s.status !== 'closed');

    const avgMin = st.avg_completion_seconds ? (st.avg_completion_seconds / 60).toFixed(1) + ' min' : '\u2014';
    document.getElementById('detail-stats').innerHTML = `
        <div class="stat-box"><div class="num">${st.active_participants}</div><div class="lbl">Active Now</div></div>
        <div class="stat-box"><div class="num">${st.completed_participants}</div><div class="lbl">Completed</div></div>
        <div class="stat-box"><div class="num">${st.total_participants}</div><div class="lbl">Total</div></div>
        <div class="stat-box"><div class="num">${avgMin}</div><div class="lbl">Avg Time</div></div>`;

    // Participants table
    const tbody = document.getElementById('participant-tbody');
    tbody.innerHTML = '';
    const select = document.getElementById('convo-select');
    select.innerHTML = '<option value="">Select participant...</option>';
    data.participants.forEach((p, i) => {
        const dur = p.duration_seconds ? (p.duration_seconds / 60).toFixed(1) + 'm' : '\u2014';
        const time = new Date(p.started_at).toLocaleString();
        const statusClass = p.status === 'active' ? 'badge-active' : p.status === 'completed' ? 'badge-active' : 'badge-closed';
        tbody.innerHTML += `<tr onclick="selectParticipant(${i})">
            <td>${p.id.substring(0,8)}</td>
            <td><span class="badge ${statusClass}">${p.status}</span></td>
            <td>${p.message_count}</td>
            <td>${dur}</td>
            <td>${time}</td>
        </tr>`;
        select.innerHTML += `<option value="${i}">P-${p.id.substring(0,8)} (${p.status})</option>`;
    });

    // Settings
    document.getElementById('edit-title').value = s.title;
    document.getElementById('edit-topic').value = s.topic;
    document.getElementById('edit-prompt').value = s.system_prompt || '';
    document.getElementById('edit-facilitator-intro').value = s.facilitator_intro || '';
    const surveys = await api('/api/surveys');
    const full = surveys.find(x => x.id === currentSurveyId);
    if (full) document.getElementById('edit-max').value = full.max_messages;
}

function selectParticipant(idx) {
    switchTab('conversation', document.querySelectorAll('.tab')[2]);
    document.getElementById('convo-select').value = idx;
    showConversation(idx);
}

function showConversation(idx) {
    if (idx === '' || !currentResults) return;
    const p = currentResults.participants[idx];
    const viewer = document.getElementById('convo-viewer');
    viewer.innerHTML = '';
    p.messages.forEach(m => {
        if (m.content.startsWith('[TOOL_EVENTS]')) return;
        viewer.innerHTML += `<div class="convo-msg"><div class="role">${m.role}</div><div class="text">${esc(m.content)}</div></div>`;
    });
}

function switchTab(name, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
}

async function closeSurvey() {
    if (!confirm('Close this survey? Active participants will be marked as abandoned.')) return;
    await api(`/api/surveys/${currentSurveyId}/close`, 'POST');
    refreshDetail();
}

async function reopenSurvey() {
    await api(`/api/surveys/${currentSurveyId}/reopen`, 'POST');
    refreshDetail();
}

async function deleteSurvey() {
    if (!confirm('Permanently delete this survey and all responses?')) return;
    try {
        await api(`/api/surveys/${currentSurveyId}`, 'DELETE');
        showList();
    } catch (e) { alert('Failed to delete: ' + e.message); }
}

async function saveSettings() {
    const data = {
        title: document.getElementById('edit-title').value.trim(),
        topic: document.getElementById('edit-topic').value.trim(),
        system_prompt: document.getElementById('edit-prompt').value.trim() || undefined,
        facilitator_intro: document.getElementById('edit-facilitator-intro').value.trim() || undefined,
        max_messages: parseInt(document.getElementById('edit-max').value) || undefined,
    };
    await api(`/api/surveys/${currentSurveyId}`, 'PATCH', data);
    alert('Settings saved!');
    refreshDetail();
}

// ── Insights ──
async function loadInsights() {
    document.getElementById('insights-loading').classList.remove('hidden');
    document.getElementById('insights-content').classList.add('hidden');
    try {
        const data = await api(`/api/surveys/${currentSurveyId}/insights`);
        currentInsights = data.insights;
        renderInsights(data.insights);
        document.getElementById('insights-loading').classList.add('hidden');
        document.getElementById('insights-content').classList.remove('hidden');
    } catch (e) {
        document.getElementById('insights-loading').textContent = 'No data available yet.';
    }
}

async function regenerateInsights() {
    document.getElementById('insights-loading').textContent = 'Regenerating insights...';
    document.getElementById('insights-loading').classList.remove('hidden');
    document.getElementById('insights-content').classList.add('hidden');
    try {
        const data = await api(`/api/surveys/${currentSurveyId}/insights/regenerate`, 'POST');
        currentInsights = data.insights;
        renderInsights(data.insights);
        document.getElementById('insights-loading').classList.add('hidden');
        document.getElementById('insights-content').classList.remove('hidden');
    } catch (e) {
        document.getElementById('insights-loading').textContent = 'Failed to generate insights: ' + e.message;
    }
}

function renderInsights(insights) {
    renderSentimentChart(insights.sentiment || {});
    renderThemesList(insights.themes || []);
    renderEngagementChart(insights.participants || []);
    renderInsightsTable(insights.participants || []);
}

function renderSentimentChart(sentiment) {
    const total = (sentiment.positive || 0) + (sentiment.neutral || 0) + (sentiment.negative || 0);
    const container = document.getElementById('sentiment-chart');
    if (total === 0) { container.innerHTML = '<p style="color:var(--muted);font-size:0.88rem">No data</p>'; return; }

    const pct = v => total > 0 ? Math.round((v / total) * 100) : 0;
    container.innerHTML = `
        <div class="sentiment-bar">
            <span class="label">Positive</span>
            <div class="bar-bg"><div class="bar-fill bar-positive" style="width:${pct(sentiment.positive)}%">${pct(sentiment.positive)}%</div></div>
        </div>
        <div class="sentiment-bar">
            <span class="label">Neutral</span>
            <div class="bar-bg"><div class="bar-fill bar-neutral" style="width:${pct(sentiment.neutral)}%">${pct(sentiment.neutral)}%</div></div>
        </div>
        <div class="sentiment-bar">
            <span class="label">Negative</span>
            <div class="bar-bg"><div class="bar-fill bar-negative" style="width:${pct(sentiment.negative)}%">${pct(sentiment.negative)}%</div></div>
        </div>`;
}

function renderThemesList(themes) {
    const container = document.getElementById('themes-list');
    if (!themes.length) { container.innerHTML = '<p style="color:var(--muted);font-size:0.88rem">No themes detected</p>'; return; }
    container.innerHTML = themes.slice(0, 8).map((t, i) =>
        `<div class="theme-item">
            <span class="theme-rank">${i + 1}</span>
            <span class="theme-name">${esc(t.name)}</span>
            <span class="theme-count">${t.count}</span>
        </div>`
    ).join('');
}

function renderEngagementChart(participants) {
    const container = document.getElementById('engagement-chart');
    if (!participants.length) { container.innerHTML = '<p style="color:var(--muted);font-size:0.88rem">No data</p>'; return; }

    // Create histogram buckets 1-10
    const buckets = Array(10).fill(0);
    participants.forEach(p => {
        const eng = Math.max(1, Math.min(10, Math.round(p.engagement || 5)));
        buckets[eng - 1]++;
    });
    const max = Math.max(...buckets, 1);

    container.innerHTML = '<div class="engagement-histogram" style="margin-bottom:24px">' +
        buckets.map((count, i) =>
            `<div class="histogram-bar" style="height:${(count / max) * 100}%">
                <span class="bar-label">${i + 1}</span>
            </div>`
        ).join('') + '</div>';
}

function renderInsightsTable(participants) {
    const tbody = document.getElementById('insights-tbody');
    if (!participants.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted)">No data</td></tr>'; return; }

    let sorted = [...participants];
    if (insightsSortCol) {
        sorted.sort((a, b) => {
            let va = a[insightsSortCol], vb = b[insightsSortCol];
            if (typeof va === 'string') va = va.toLowerCase();
            if (typeof vb === 'string') vb = vb.toLowerCase();
            if (va < vb) return insightsSortAsc ? -1 : 1;
            if (va > vb) return insightsSortAsc ? 1 : -1;
            return 0;
        });
    }

    tbody.innerHTML = sorted.map(p => {
        const dotClass = p.sentiment === 'positive' ? 'dot-positive' : p.sentiment === 'negative' ? 'dot-negative' : 'dot-neutral';
        const eng = p.engagement || 0;
        const engClass = eng >= 7 ? 'eng-high' : eng >= 4 ? 'eng-mid' : 'eng-low';
        const themes = (p.themes || []).slice(0, 3).map(t => esc(t)).join(', ');
        return `<tr>
            <td>${esc(p.id || '')}</td>
            <td><span class="sentiment-dot ${dotClass}"></span>${p.sentiment || 'unknown'}</td>
            <td><span class="engagement-badge ${engClass}">${eng}/10</span></td>
            <td style="font-size:0.82rem;color:var(--muted)">${themes || '\u2014'}</td>
        </tr>`;
    }).join('');
}

function sortInsightsTable(col) {
    if (insightsSortCol === col) { insightsSortAsc = !insightsSortAsc; }
    else { insightsSortCol = col; insightsSortAsc = true; }
    if (currentInsights) renderInsightsTable(currentInsights.participants || []);
}

// ── Analysis Chat ──
async function loadAnalysisHistory() {
    const msgs = await api(`/api/surveys/${currentSurveyId}/analysis-history`);
    const container = document.getElementById('analysis-messages');
    container.innerHTML = '';
    msgs.forEach(m => {
        const el = document.createElement('div');
        el.className = `analysis-msg ${m.role}`;
        el.textContent = m.content;
        container.appendChild(el);
    });
    container.scrollTop = container.scrollHeight;
}

async function sendAnalysis() {
    const input = document.getElementById('analysis-input');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';

    const container = document.getElementById('analysis-messages');
    const userEl = document.createElement('div');
    userEl.className = 'analysis-msg user';
    userEl.textContent = text;
    container.appendChild(userEl);
    container.scrollTop = container.scrollHeight;

    document.getElementById('analysis-send').disabled = true;
    try {
        const res = await api(`/api/surveys/${currentSurveyId}/analyze`, 'POST', {
            survey_id: currentSurveyId, message: text
        });
        const el = document.createElement('div');
        el.className = 'analysis-msg assistant';
        el.textContent = res.response;
        container.appendChild(el);
        container.scrollTop = container.scrollHeight;
    } catch (e) {
        const el = document.createElement('div');
        el.className = 'analysis-msg assistant';
        el.textContent = 'Error: ' + e.message;
        container.appendChild(el);
    } finally {
        document.getElementById('analysis-send').disabled = false;
        input.focus();
    }
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// ── Init ──
if (token) {
    api('/api/surveys').then(() => showDashboard()).catch(() => doLogout());
}

// Auto-refresh every 15s
setInterval(() => {
    if (currentSurveyId && !document.getElementById('detail-view').classList.contains('hidden')) {
        refreshDetail();
    }
}, 15000);
</script>
</body>
</html>
